一、模块划分
1、组件库
    组件开发，编译发布。
2、瞻星平台
    可视化页面配置。活动管理、页面管理、组件数据配置
3、在线服务

1.2 平台功能
1.2.1 名词解释
* 活动（activity）：每个热点事件是一个活动，用来管理数据、页面等
* 页面（page）：最终对外展示的页面，一个活动可以由多个页面组成
* 组件/卡片（component/card）：组成页面的基础单元，可绑定可视化数据
* 页面配置（pageConf）：描述一个页面由哪些卡片/组件组成，每个卡片、组件的样式信息以及绑定的可视化数据
* 可视化数据（uiData）：可被组件/卡片引用的数据，基于原始数据与计算规则生成，由id、表达式、参数等部分组成
* 原始数据（rawData）：用于组合成可视化数据，由编辑组件或离线脚本生成，按照key-value方式存储在sndb中，原始数据可设置key与schema的对应关系，入库时做检查
* 编辑平台（editPlatform）：用于编辑卡片/组件所需数据的平台，由编辑组件、审核组件组成
* 编辑组件（editComponent）：可以与一些常用组件一一对应，通过该组件编辑的数据可发布到原始数据的指定key中，简单场景可直接透传至uiData
* 审核组件（auditComponent）：离线引入的数据可以只写入预览环境，经审核组件审核后写入线上
* 数据引入（dataImporter）：接入离线数据的模块，自动同步rawData绑定的schema，并校验输入数据
* schema：每个都关联一个jsonschema配置，原始数据、可视化数据都遵循特定的schema，每个组件/卡片的数据也有schema要求

1.2.2 B端—平台服务



卡片管理
卡片是组成页面的基本单元，由fe遵循一定原则开发。卡片是全局粒度，定义后在所有活动中都可以使用。
页面可以添加卡片，卡片的的运行，依赖对应的前端运行时，按场景分为mock（开发）、edit（配置）、online（线上）三套，运行时本身可单独使用，也是大数据页面的运行基础。
大数据平台主要是提供卡片的发布&管理功能，包括：
1、卡片发布&版本管理
2、卡片列表查看&schema的获取
3、卡片依赖管理
此外，还有卡片开发工具等配套工具。

活动管理
活动是管理页面、数据的单元。
活动管理主要功能包括：
1、活动添加&编辑
2、活动列表查看&选择
3、活动有效期管理

页面编辑
页面编辑是通过可视化的方式，将多个卡片组装成页面，卡片可定义一些基本文案、样式，并绑定卡片数据（例如图表中的数据）。
页面是属于某个活动中的，页面中可用的数据都是在这个活动内定义的数据。
主要的功能包括：
1、页面的创建、编辑、删除
2、页面列表查看
3、页面的预览
页面的创建过程，就是生成页面配置（pageConf）的过程
页面创建后，会有对应的线上链接地址

schema管理
schema分为两类：
1、卡片数据schema：与卡片依赖的数据有关，创建卡片时会同步创建相关的schema，全局性质
2、活动数据schema：在活动内创建的schema，用于更详细的校验或拆分卡片schema
schema的核心信息是一组jsonschema配置，此外还包括名称等信息便于管理，平台需要提供的功能包括：
1、schema的注册/编辑，区分schema的类型，卡片schema由卡片发布过程自动创建
2、schema列表的获取
3、提供数据+schema名称，校验schema是否合法，若不合法给出错误提示
需要绑定schema的主要是原始数据和卡片数据，原始数据可任意绑定两种schema之一，卡片数据必须绑定卡片schema，可以选择绑定数据schema（这种情况下，数据schema是对前者的细化，不能产生矛盾，主要是暂时未想到schema继承关系的解决办法）

卡片数据管理
卡片卡片数据主要包括：id、表达式、参数、schema四个重要部分组成。
卡片数据必须绑定卡片schema，可选择绑定普通的数据schema，但是两者不能产生冲突。
* 前端通过id+参数的方式，获取数据
* schema用于校验数据是否满足卡片的要求
* 表达式用于灵活设置数据格式，提供诸如分页、筛选等高级逻辑
平台上，卡片数据管理主要的功能包括
1、卡片数据的创建、编辑、删除
2、卡片数据列表页
3、按卡片数据schema查询卡片数据

卡片数据的核心在于，如何定义表达式、在线如何解析表达式、如何通过表达式扩展功能。

原始数据管理
原始数据管理，主要用于管理写入sndb的数据，核心信息包括：key规则、key参数、schema。原始数据的schema可以绑定卡片schema，也可以绑定数据schema
以高考大数据为例：

key规则为：collage_basic_info_${province}_${subject}，也可以无参数，例如collage_basic_info
参数为：province，subject
schema：collage_basic_info，schema的名字，具体代表一个jsonschema配置

平台上，原始数据管理主要的功能包括
1、原始数据的创建、编辑、删除
2、原始数据列表页

数据编辑
数据编辑是直接通过在平台创建编辑表单，编辑原始数据，例如当前热榜等配置场景。主要编辑逻辑是从原始数据预览环境中读取数据，编辑后重新写入预览环境。
数据编辑是活动粒度的，每个活动的编辑组件相互不可见。

数据编辑的主要平台功能包括：
1、可扩展的编辑组件定义，可根据json_schema自动生成一个编辑表单，完成配置
2、添加编辑组件（每个编辑组件添加时，需要绑定或创建对应的原始数据）
3、删除编辑组件
4、编辑组件列表
5、数据编辑页（通过编辑组件编辑数据）
6、查看编辑中数据的diff
7、数据预览（使用预览环境的数据查看页面效果）
8、数据发布（从预览环境到线上环境）
9、数据重置（使用线上环境的数据覆盖预览环境）
10、数据回滚（保留多个版本的线上环境数据、可选择回滚到之前发布的数据版本）

数据引入
原始数据除平台编辑外，还有其他一部分是通过离线脚本定时生成的，需要通过数据引入功能接入平台。
数据引入主要提供的功能有：
1、校验引入的数据，是否在平台定义了key，以及value是否满足对应key的schema校验规则
2、自动同步平台原始数据schema定义
3、未通过校验的key，将错误信息通知给key的负责人，key未定义时，通知活动负责人
4、通过校验的key，若需要进行审核的key，只写入预览环境，并通知平台进行审核，不需要审核则直接写入预览+线上环境

数据审核
离线导入的数据，若更新不频繁/key不太多，可只写入预览环境，同时通知平台，生成一条审核记录。
平台审核通过后，将预览环境的数据发布到线上，实现离线数据接入的管理。

数据审核提供的平台功能主要包括：
1、数据审核通知api（待审核的key，对应的原始数据）
2、审核列表，提供待审核的所有key列表，一个key同时只能有一个待审核数据
3、数据预览（使用预览环境的数据查看页面效果）
4、数据发布（从预览环境到线上环境）
5、数据重置（使用线上环境的数据覆盖预览环境）
6、审核通知？当有数据待审核时，通知对应审核同学操作

1.2.3 C端—在线服务
配置好的数据，通过在线模块对外提供服务，需要提供稳定且容量足够大在线服务
在线部分的主要功能包括：
1、根据活动、页面名称加载&渲染页面
2、卡片数据表达式的解析&执行，并提供同步、异步数据结构
3、卡片数据表达式的验证&调试
4、页面的预览（可以分别按页面配置、数据、代码上线三种变更预览）
5、原始数据操作api，数据的读写
6、原始数据操作api，数据的发布（传入版本，读取preview中版本，版本核对通过写入线上，否则失败）

1.3 平台进展
瞻星平台（http://zhanxing.baidu-int.com/）于2020年Q4上线，目前支持了三块业务，一是大数据业务（主要业务，例如高考大数据、奥运大数据），二是简单的运营活动页（例如百度传情墙），三是手百 open widget （提供组件配置能力）。







2 技术选型和实现
2.1 整体架构


2.2 模块划分
从前端视角，瞻星平台主要分为 在线服务、配置平台 两块
模块
子模块
技术栈
作用
在线服务
服务端
odp
提供页面配置和数据

前端模板
san
负责页面框架渲染和组件加载

前端组件库
san
实现业务功能
配置平台
平台web服务
odp, vue
管理活动、页面和数据

卡片服务
node, NestJS
复杂卡片管理

前端架构图如下：


2.2.1 在线服务
在线服务面向用户，页面URL类似：http://motion.baidu.com/activity/aid/page?pageNum=1&pageSize=20&province=全国

服务端（odp）
根据活动、页面名称获取页面配置和动态数据（需注意页面配置、页面数据配置都可以命中缓存）。
后端执行流程
* 解析page表中对应的页面描述json。解析出需要同步渲染的dataId（carddata的id）。
* 根据dataId取出所有的数据表达式。需要参数的通过data参数中 对应的参数获取
* 解析数据表达式。返回的数据，填充到页面描述json中
* 加载tpl模板，页面json放到固定字段返回前端。

前端模板（san）
页面加载后，模板根据页面配置和卡片数据（tpl模板字段 $extArray['tplData']）进行组件渲染。
具体流程是
* 提取页面配置，进行数据预处理
* 收集js依赖，配置esl
* 根据PC、wise去拼接页面结构，并创建san组件实例进行挂载
* 进行日志和环境初始化


前端组件库（san）
组件库提供了本地调试、组件发布等能力。
* 安装依赖：npm install
* 新增卡片： npm run add ${cardName}
* 本地预览卡片：npm start ${cardName}
* 编译部署：npm run build ${cardName}
* 发布卡片： npm run publish ${cardName}
* 文档预览：npm run dev:site

 组件实现具体业务功能，每个组件对应src/app 下的一个目录，包括以下基本文件：
* example
  * index.html: 页面模板
  * main.js: 卡片渲染器（js入口）
  * reset.css: 重置样式
* src
  * card.san: 卡片代码
  * mock.json: 本地模拟数据（本地预览时，使用 mock.json 中的数据进行卡片初始化）
  * package.json: 卡片描述信息
  * schema.json: 卡片数据格式

组卡开发流程如下图：


2.2.2 配置平台
平台web服务（odp）
面向PM和研发，提供活动/页面管理、数据管理等功能。

前端使用vue/vue-router/vuex进行开发，主要页面包括：
页面
路由
功能
备注
首页
/
管理活动列表
目前没有专门的首页
活动管理
/
管理活动列表

活动信息页
/activity/info
管理一个活动的基础信息

页面管理
/page/list
管理一个活动的页面列表

页面编辑
/editor/index
编辑页面内容

原始数据管理
/rawdata/list
管理原始数据，可供卡片数据使用

卡片数据管理
/carddata/list
管理卡片数据，可供卡片绑定

数据编辑
/rawdataEditor/list
管理人工编辑数据

数据审核
/audit/index
展示审核记录
目前是自动审核
组件管理
/card
管理组件与tag的关联

标签管理
/tag
管理组件相关的tag


卡片服务（node）
面向FE，提供卡片管理功能。
* 发布：组件开发后，通过命令行工具进行组件发布。
* 查询：平台配置页面时，需要展示可用组件。

卡片服务提供线下、线上两套环境，分别用于开发和上线。
卡片发布的流程包括：
* 文件包解析，得到卡片描述文件
* 查询数据库，得到卡片信息
* 进行卡片版本检查，如果失败则返回错误
* 把卡片文件发布到bos
* 更新数据库

卡片版本号，要求按规范维护



2.3 代码库和上线方案
* 组件 https://console.cloud.baidu-int.com/devops/icode/repos/baidu/ps-se-activity/astrology-card/tree/master
* 模板 https://console.cloud.baidu-int.com/devops/icode/repos/baidu/ps-se-fe-tpl/search-activity-san/tree/master
* 平台 https://console.cloud.baidu-int.com/devops/icode/repos/baidu/ps-se-activity/astrology-platform-tpl/tree/master
* node服务 https://console.cloud.baidu-int.com/devops/icode/repos/baidu/ps-se-activity/astrology-node/tree/master

上线方案详见瞻星平台前端上线文档
模块名
业务
模块负责人
上线平台
备注
astrology-platform-tpl
瞻星平台
伟伟
opera

astrology-node
瞻星node
伟伟
opera

astrology-card
瞻星H5组件
伟伟
-
FE在本地发布到平台
search-activity-san
瞻星H5模板
伟伟
tower


3 存在的问题
3.1 当前业务模式

开发&测试过程（平台线下环境）：
* FE开发组件，自测完成后发布到平台
* RD开发数据
* FE在平台上创建活动&页面，RD创建原始数据&卡片数据
* FE配置人工编辑数据（测试数据），并进行数据绑定
* QA在线下进行测试

上线过程（平台线上环境）：
* PM在平台上创建活动&页面，RD创建原始数据&卡片数据，
* PM配置人工编辑数据（真实数据），并进行数据绑定
* QA在线上（预览环境）进行回归
* PM发布上线

3.2 问题思考
3.2.1 第三方业务接入成本较高
问题：
* 瞻星平台在设计上考虑了大数据等复杂的数据处理场景，第三方业务接入时的理解成本较高
思路：
* 增加多业务线管理，数据隔离，例如手百open widget可作为一个独立的业务
* 支持平台定制化，把一部分平台操作进行简化

3.2.2 结果页和落地页存在重复开发
问题：
* 瞻星组件的方案与搜索结果页不完全一致，可能会造成重复开发
思路：
* 增加对 talos、cosmic 等组件方案的支持
* 服务端node化，与结果页保持一致
